{% extends 'base.html' %}

{% block title %}{{ session.title }} - RAG Chatbot{% endblock %}

{% block extra_head %}

<style>
    #chat-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    #message-container {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .user-message {
        background-color: #dcf8c6;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .assistant-message {
        background-color: #fff;
        border: 1px solid #ddd;
    }
    
    .system-message {
        background-color: #e6e6e6;
        color: #666;
        font-style: italic;
        text-align: center;
        margin: 10px auto;
        padding: 5px 10px;
        border-radius: 10px;
        max-width: 70%;
    }
    
    #input-container {
        display: flex;
        margin-top: 10px;
    }
    
    #message-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px 0 0 8px;
        font-size: 16px;
    }
    
    #send-button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        font-size: 16px;
    }
    
    #send-button:hover {
        background-color: #45a049;
    }
    
    /* Styling for code blocks */
    pre {
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
    }
    
    code {
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
    <div id="chat-container" data-session-id="{{ session.id }}">
        <h1>Chat with Persona AI</h1>
        
        <div id="message-container">
            <!-- Messages will be inserted here dynamically -->
            {% for message in messages %}
                <div class="message {% if message.role == 'USER' %}user-message{% else %}assistant-message{% endif %}">
                    {{ message.content|safe }}
                </div>
            {% endfor %}
        </div>
        
        <div id="input-container">
            <input id="message-input" type="text" placeholder="Type your message here...">
            <button id="send-button">Send</button>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    // WebSocket chat client for PersonaAI
// Include this in your HTML template

document.addEventListener('DOMContentLoaded', function() {
    const messageContainer = document.getElementById('message-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    // Get session ID from the URL or a data attribute
    const sessionId = document.querySelector('[data-session-id]').getAttribute('data-session-id');
    
    // Connect to WebSocket
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + sessionId + '/'
    );
    
    let assistantMessageElement = null;
    
    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
        addSystemMessage('Connected to chat session');
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        switch(data.type) {
            case 'assistant_response_start':
                // Create a new message element for the assistant's response
                assistantMessageElement = document.createElement('div');
                assistantMessageElement.className = 'message assistant-message';
                messageContainer.appendChild(assistantMessageElement);
                break;
                
            case 'assistant_response_chunk':
                // Append the chunk to the current assistant message
                if (assistantMessageElement) {
                    assistantMessageElement.innerHTML += data.message;
                    // Auto-scroll to bottom
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                }
                break;
                
            case 'assistant_response_end':
                // Message is complete, apply any final formatting
                if (assistantMessageElement) {
                    // Apply Markdown formatting or other post-processing here if needed
                    assistantMessageElement = null;
                }
                break;
                
            default:
                console.log('Unknown message type:', data);
        }
    };
    
    chatSocket.onclose = function(e) {
        addSystemMessage('Chat connection closed. Please refresh the page to reconnect.');
        console.log('WebSocket connection closed');
    };
    
    chatSocket.onerror = function(e) {
        addSystemMessage('Error with the chat connection.');
        console.error('WebSocket error:', e);
    };
    
    // Send message when button is clicked
    sendButton.addEventListener('click', sendMessage);
    
    // Send message when Enter key is pressed
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            // Add user message to UI
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'message user-message';
            userMessageElement.textContent = message;
            messageContainer.appendChild(userMessageElement);
            
            // Send message through WebSocket
            chatSocket.send(JSON.stringify({
                'message': message,
                'session_id': sessionId
            }));
            
            // Clear input
            messageInput.value = '';
            
            // Auto-scroll to bottom
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    }
    
    function addSystemMessage(text) {
        const systemMessageElement = document.createElement('div');
        systemMessageElement.className = 'message system-message';
        systemMessageElement.textContent = text;
        messageContainer.appendChild(systemMessageElement);
        
        // Auto-scroll to bottom
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }
});
</script>
{% endblock %}